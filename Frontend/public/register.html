<!doctype html>
<html lang="fr">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>FinanceFlow — Register</title>
		<link rel="stylesheet" href="styles.css">
	</head>
	<body>
		<main class="container">
			<section class="card">
				<h1 class="brand">Créer un compte</h1>

				<form id="registerForm">
					<label class="field">
						<span>Nom complet</span>
						<input id="name" name="name" type="text" required placeholder="Votre nom">
					</label>

					<label class="field">
						<span>Email</span>
						<input id="email" name="email" type="email" required placeholder="votre@email.com">
					</label>

					<label class="field">
						<span>Mot de passe</span>
						<input id="password" name="password" type="password" required placeholder="Mot de passe">
					</label>

					<label class="field">
						<span>Confirmer mot de passe</span>
						<input id="password2" name="password2" type="password" required placeholder="Confirmer mot de passe">
					</label>

					<button type="submit" class="btn primary">S'inscrire</button>
				</form>

				<p style="margin-top:12px;">
					<!-- Link to the dashboard after registration (computed base so it works in dev and deployed) -->
					<a id="backToDashboard" href="#" class="link">Retour au tableau de bord</a>
				</p>
			</section>
		</main>

			<script>
				// API helper - SHARED FUNCTION
				window.getApiBase = function(){
					const protocol = window.location.protocol;
					const hostname = window.location.hostname;
					const port = window.location.port;
					
					if(port === '5173') return protocol + '//' + hostname + ':8000';
					if(!port || port === '80' || port === '443') return protocol + '//' + hostname;
					return protocol + '//' + hostname + ':' + port;
				};

				window.apiCall = function(endpoint){
					return getApiBase() + '/Backend/' + endpoint;
				};

				// Registration form
				document.getElementById('registerForm').addEventListener('submit', async function(e){
					e.preventDefault();
					
					const name = document.getElementById('name').value.trim();
					const email = document.getElementById('email').value.trim().toLowerCase();
					const password = document.getElementById('password').value;
					const password2 = document.getElementById('password2').value;

					if(!name || !email || !password){
						alert('Veuillez remplir tous les champs');
						return;
					}
					if(password !== password2){
						alert('Les mots de passe ne correspondent pas');
						return;
					}

					// Split name
					const parts = name.split(/\s+/);
					const prenom = parts.shift();
					const nom = parts.join(' ') || '';

					try{
						const res = await fetch(apiCall('router.php/register'), {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ prenom, nom, email, password }),
							credentials: 'include'
						});
						
						const data = await res.json();
						
						if(data.ok){
							alert('Inscription réussie ! Redirection vers le login...');
							window.location.href = '../../index.html';
						} else {
							alert(data.message || 'Erreur lors de l\'inscription');
						}
					}catch(e){
						console.error('Error:', e);
						alert('Erreur réseau');
					}
				});

				// Back link
				document.getElementById('backToDashboard').href = 'dashboard.html';
			</script>
	</body>
</html>
